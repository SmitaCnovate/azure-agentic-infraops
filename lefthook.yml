# lefthook.yml - Git hooks configuration
# Replaces Husky with a faster, dependency-free alternative
# https://github.com/evilmartians/lefthook

pre-commit:
  parallel: false
  commands:
    markdown-lint:
      glob: "*.md"
      run: |
        # Get staged markdown files
        STAGED_MD=$(git diff --cached --name-only --diff-filter=ACM | grep '\.md$' || true)
        if [ -n "$STAGED_MD" ]; then
          COUNT=$(echo "$STAGED_MD" | wc -l | tr -d ' ')
          echo "ğŸ“ Validating $COUNT markdown file(s)..."
          # Lint staged files only, suppress verbose Finding: output
          RESULT=$(echo "$STAGED_MD" | xargs markdownlint-cli2 --no-globs 2>&1)
          # Show only Summary and errors, skip Finding/Linting lines
          echo "$RESULT" | grep -v -E '^(Finding:|Linting:)' || true
        else
          echo "â„¹ï¸  No markdown files to validate"
        fi
      stage_fixed: true

    link-check:
      glob: "docs/**/*.md"
      run: |
        # Get staged docs markdown files
        STAGED_DOCS=$(git diff --cached --name-only --diff-filter=ACM | grep '^docs/.*\.md$' || true)
        if [ -n "$STAGED_DOCS" ]; then
          echo "ğŸ”— Checking links in $(echo "$STAGED_DOCS" | wc -l | tr -d ' ') doc file(s)..."
          # Use npx to run from local node_modules (avoids Node.js 24 global install bug)
          echo "$STAGED_DOCS" | xargs -I {} npx markdown-link-check {} --config .markdown-link-check.json --quiet
        else
          echo "â„¹ï¸  No docs to check links"
        fi

    h2-sync:
      glob: "{.github/skills/azure-artifacts/SKILL.md,.github/instructions/artifact-h2-reference*,scripts/validate-artifact-templates*}"
      run: |
        STAGED_SYNC=$(git diff --cached --name-only --diff-filter=ACM | grep -E '(SKILL\.md|artifact-h2-reference|validate-artifact-templates)' || true)
        if [ -n "$STAGED_SYNC" ]; then
          echo "ğŸ”„ Checking H2 heading sync across sources..."
          npm run lint:h2-sync
        else
          echo "â„¹ï¸  No H2-source files to sync-check"
        fi
      fail_text: |
        âŒ H2 heading sync failed!

        Sources must match: SKILL.md â†” artifact-h2-reference â†” validator
        ğŸ”§ Run: npm run lint:h2-sync

    artifact-validation:
      glob: "{agent-output,.github/skills/azure-artifacts/templates}/**/*.md"
      run: |
        # Check if any agent-output artifacts are staged
        STAGED_ARTIFACTS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^agent-output/.*\.md$' || true)
        if [ -n "$STAGED_ARTIFACTS" ]; then
          COUNT=$(echo "$STAGED_ARTIFACTS" | wc -l | tr -d ' ')
          echo "ğŸ“‹ Validating $COUNT artifact(s) against templates..."
          # Run full artifact validation - blocks on any H2 mismatch
          if ! npm run lint:artifact-templates; then
            echo ""
            echo "âŒ Artifact template validation failed!"
            echo ""
            echo "ğŸ”§ To fix:"
            echo "   1. Check .github/instructions/artifact-h2-reference.instructions.md"
            echo "   2. Use EXACT H2 headings from that file"
            echo "   3. Run: npm run fix:artifact-h2 <file> --apply"
            echo "   4. Re-stage and commit"
            echo ""
            exit 1
          fi
        else
          echo "â„¹ï¸  No agent-output artifacts to validate"
        fi
      fail_text: |
        âŒ Artifact H2 structure validation failed!

        ğŸ“š Reference: .github/instructions/artifact-h2-reference.instructions.md
        ğŸ”§ Auto-fix: npm run fix:artifact-h2 <file> --apply

    agent-frontmatter:
      glob: "**/*.agent.md"
      run: |
        # Check if any agent files are staged
        STAGED_AGENTS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.agent\.md$' || true)
        if [ -n "$STAGED_AGENTS" ]; then
          COUNT=$(echo "$STAGED_AGENTS" | wc -l | tr -d ' ')
          echo "ğŸ¤– Validating $COUNT agent file(s)..."
          npm run lint:agent-frontmatter
        else
          echo "â„¹ï¸  No agent files to validate"
        fi
      fail_text: |
        âŒ Agent frontmatter validation failed!

        ğŸ”§ Check YAML syntax in agent definitions
        ğŸ“š Reference: .github/instructions/agents-definitions.instructions.md

    instruction-frontmatter:
      glob: "**/*.instructions.md"
      run: |
        STAGED_INSTR=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.instructions\.md$' || true)
        if [ -n "$STAGED_INSTR" ]; then
          COUNT=$(echo "$STAGED_INSTR" | wc -l | tr -d ' ')
          echo "ğŸ“‹ Validating $COUNT instruction file(s)..."
          npm run lint:instruction-frontmatter
        else
          echo "â„¹ï¸  No instruction files to validate"
        fi
      fail_text: |
        âŒ Instruction frontmatter validation failed!

        ğŸ“š Allowed fields: description, applyTo
        ğŸ”§ Remove any non-standard fields from YAML frontmatter

commit-msg:
  commands:
    commitlint:
      run: npx --no -- commitlint --edit {1}
      fail_text: |
        âŒ Commit message validation failed!

        ğŸ“– Conventional Commits format required:
           <type>[optional scope]: <description>

           Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert

           Examples:
             feat: add new Azure App Service module
             fix(bicep): correct storage account naming
             docs: update README with deployment steps

# Post-commit validation checks (enforced)
post-commit:
  commands:
    version-sync:
      run: |
        echo "ğŸ” Checking version synchronization..."
        node scripts/validate-version-sync.mjs
      fail_text: "âŒ Version sync check failed"

    deprecated-refs:
      glob: "*.md"
      run: |
        echo "ğŸ” Checking for deprecated references..."
        node scripts/validate-no-deprecated-refs.mjs
      fail_text: "âŒ Deprecated references check failed"

    json-syntax:
      glob: "*.json"
      run: |
        echo "ğŸ” Validating JSON syntax..."
        STAGED_JSON=$(git diff --cached --name-only --diff-filter=ACM | grep '\.json$' | grep -v node_modules | grep -v infra || true)
        if [ -n "$STAGED_JSON" ]; then
          for f in $STAGED_JSON; do
            node -e "JSON.parse(require('fs').readFileSync('$f'))" 2>/dev/null && echo "  âœ“ $f" || { echo "  âœ— $f - Invalid JSON"; exit 1; }
          done
        fi
      fail_text: "âŒ JSON syntax validation failed"
