name: Validate simple-web-api Artifacts

on:
  pull_request:
    branches:
      - chore/templatize-artifacts
      - main
    paths:
      - agent-output/simple-web-api/**
      - .github/templates/**
      - .github/agents/**
      - scripts/validate-simple-web-api.mjs
  push:
    branches:
      - chore/templatize-artifacts
    paths:
      - agent-output/simple-web-api/**
      - .github/templates/**
      - .github/agents/**
      - scripts/validate-simple-web-api.mjs
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    name: Validate Template Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Validate simple-web-api artifacts
        id: validate
        run: npm run validate:simple-web-api
        continue-on-error: true

      - name: Validate Wave 1 artifacts (overall)
        id: validate-wave1
        run: npm run lint:wave1-artifacts
        env:
          STRICTNESS: relaxed
        continue-on-error: true

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const simpleWebApiStatus = '${{ steps.validate.outcome }}';
            const wave1Status = '${{ steps.validate-wave1.outcome }}';

            let emoji = '✅';
            let status = 'PASSED';

            if (simpleWebApiStatus === 'failure' || wave1Status === 'failure') {
              emoji = '❌';
              status = 'FAILED';
            }

            const body = `## ${emoji} Agent Output Validation: ${status}

            ### simple-web-api Project: ${simpleWebApiStatus === 'success' ? '✅ PASSED' : '❌ FAILED'}

            **Template compliance check for \`agent-output/simple-web-api\`**

            - File existence
            - Required H2 heading structure
            - Diagram generation (Python + PNG)
            - Governance constraints format
            - Agent attribution metadata

            ### Wave 1 Artifacts (Overall): ${wave1Status === 'success' ? '✅ PASSED' : '⚠️ WARNINGS'}

            **All Wave 1 artifacts across the repository**

            ---

            ${status === 'FAILED' ? '⚠️ **Action Required**: Fix validation errors before merging.' : '✨ All validation checks passed!'}

            <details>
            <summary>View validation commands</summary>

            Run locally:
            \`\`\`bash
            npm run validate:simple-web-api
            npm run lint:wave1-artifacts
            \`\`\`
            </details>
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail workflow if validation failed
        if: steps.validate.outcome == 'failure'
        run: |
          echo "::error::simple-web-api validation failed. See logs above."
          exit 1
