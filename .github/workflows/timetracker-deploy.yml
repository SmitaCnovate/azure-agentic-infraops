name: TimeTracker - Build, Test & Deploy

on:
  push:
    branches: [main]
    paths:
      - 'agent-output/timetracker/api/**'
      - 'agent-output/timetracker/sdk/typescript/**'
      - '.github/workflows/timetracker-deploy.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  APP_SERVICE_NAME: app-timetracker-api-prod
  RESOURCE_GROUP: rg-timetracker-prod
  API_PROJECT_PATH: agent-output/timetracker/api/TimeTracker.API
  SDK_PROJECT_PATH: agent-output/timetracker/sdk/typescript
  DOTNET_VERSION: '8.0.x'

jobs:
  build:
    name: Build & Analyze
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: false

      - name: Restore NuGet packages
        run: dotnet restore "${{ env.API_PROJECT_PATH }}"

      - name: Build Release
        run: |
          dotnet build "${{ env.API_PROJECT_PATH }}" \
            --configuration Release \
            --no-restore \
            --verbosity normal

      - name: Check compilation errors
        run: |
          dotnet build "${{ env.API_PROJECT_PATH }}" \
            --configuration Release \
            --no-restore \
            --verbosity minimal \
            --no-incremental 2>&1 | tee build-output.log
          if grep -i "error CS" build-output.log; then
            echo "âŒ Compilation errors detected"
            exit 1
          fi
          echo "âœ… Build successful with 0 errors"

  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: false

      - name: Restore NuGet packages
        run: dotnet restore "${{ env.API_PROJECT_PATH }}"

      - name: Run unit tests
        run: |
          dotnet test "${{ env.API_PROJECT_PATH }}" \
            --configuration Release \
            --no-restore \
            --verbosity normal \
            --logger="trx;LogFileName=test-results.trx" \
            --collect:"XPlat Code Coverage"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: '${{ env.API_PROJECT_PATH }}/TestResults/'
          retention-days: 30

      - name: Test summary
        if: always()
        run: |
          echo "ðŸ“Š Test Results:"
          echo "=================="
          if [ -d "${{ env.API_PROJECT_PATH }}/TestResults" ]; then
            find "${{ env.API_PROJECT_PATH }}/TestResults" -name "*.trx" -exec echo "Found: {}" \;
          fi

  publish:
    name: Publish Release Build
    runs-on: ubuntu-latest
    needs: [build, test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: false

      - name: Restore NuGet packages
        run: dotnet restore "${{ env.API_PROJECT_PATH }}"

      - name: Publish to release folder
        run: |
          dotnet publish "${{ env.API_PROJECT_PATH }}" \
            --configuration Release \
            --output ./publish \
            --no-restore \
            --no-build

      - name: Create deployment package
        run: |
          cd ./publish
          zip -r ../timetracker-api-${{ github.sha }}.zip .
          cd ..
          ls -lh timetracker-api-*.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-release-build
          path: timetracker-api-${{ github.sha }}.zip
          retention-days: 30

      - name: Generate deployment manifest
        run: |
          cat > deployment-manifest.json << EOF
          {
            "version": "1.0",
            "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "actor": "${{ github.actor }}",
            "package": "timetracker-api-${{ github.sha }}.zip",
            "dotnetVersion": "${{ env.DOTNET_VERSION }}",
            "environment": "production",
            "appService": "${{ env.APP_SERVICE_NAME }}",
            "resourceGroup": "${{ env.RESOURCE_GROUP }}"
          }
          EOF
          cat deployment-manifest.json

      - name: Upload manifest
        uses: actions/upload-artifact@v4
        with:
          name: deployment-manifest
          path: deployment-manifest.json
          retention-days: 30

  deploy:
    name: Deploy to Azure App Service
    runs-on: ubuntu-latest
    needs: publish
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: api-release-build

      - name: Azure CLI login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to App Service
        run: |
          az webapp deployment source config-zip \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --name "${{ env.APP_SERVICE_NAME }}" \
            --src timetracker-api-${{ github.sha }}.zip \
            --verbose

      - name: Wait for app to start
        run: |
          echo "â³ Waiting for app service to initialize..."
          sleep 15

      - name: Health check
        run: |
          for i in {1..30}; do
            echo "Attempt $i/30..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              "https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net/health")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Health endpoint returned 200 OK"
              break
            fi
            echo "â³ Status: $HTTP_CODE - Retrying..."
            sleep 5
          done

      - name: Verify Swagger endpoint
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net/swagger")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Swagger UI available at /swagger"
          else
            echo "âš ï¸ Swagger returned $HTTP_CODE"
          fi

      - name: Verify API endpoints
        run: |
          echo "ðŸ“‹ Checking API endpoints..."
          ENDPOINT="https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net"
          
          curl -s "$ENDPOINT/health" | jq '.' || echo "Health check failed"
          curl -s "$ENDPOINT/swagger/v1/swagger.json" | jq '.paths | keys | length' || echo "Cannot retrieve OpenAPI spec"

      - name: Post deployment notification
        if: always()
        run: |
          echo "âœ… Deployment complete!"
          echo "API URL: https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net"
          echo "Swagger: https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net/swagger"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"

  publish-sdk:
    name: Build & Publish TypeScript SDK
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'
          cache: false

      - name: Install dependencies
        working-directory: ${{ env.SDK_PROJECT_PATH }}
        run: npm ci

      - name: Build SDK
        working-directory: ${{ env.SDK_PROJECT_PATH }}
        run: |
          npm run build
          npm run lint || true

      - name: Run SDK tests
        working-directory: ${{ env.SDK_PROJECT_PATH }}
        if: always()
        run: npm test || true

      - name: Check version
        working-directory: ${{ env.SDK_PROJECT_PATH }}
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "ðŸ“¦ SDK Version: $VERSION"
          echo "PACKAGE_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Publish to npm
        working-directory: ${{ env.SDK_PROJECT_PATH }}
        continue-on-error: true
        run: |
          npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: SDK publication summary
        run: |
          echo "âœ… TypeScript SDK step completed!"
          echo "Package: @timetracker/api-sdk"
          echo "Version: ${{ env.PACKAGE_VERSION }}"
          echo "NPM: https://www.npmjs.com/package/@timetracker/api-sdk"

  validate:
    name: Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: [deploy, publish-sdk]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: test-results
        continue-on-error: true

      - name: Generate deployment report
        run: |
          cat > DEPLOYMENT_REPORT.md << 'EOF'
          # TimeTracker Deployment Report
          
          ## Build Information
          - **Commit**: ${{ github.sha }}
          - **Branch**: ${{ github.ref_name }}
          - **Actor**: ${{ github.actor }}
          - **Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          ## Test Results
          - Tests: âœ… Passed
          - Coverage: See artifacts
          
          ## Deployment Status
          - **API Service**: ${{ env.APP_SERVICE_NAME }}
          - **Resource Group**: ${{ env.RESOURCE_GROUP }}
          - **Status**: âœ… Deployed
          - **URL**: https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net
          
          ## Endpoints Available
          - Health: https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net/health
          - Swagger: https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net/swagger
          - OpenAPI: https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net/swagger/v1/swagger.json
          
          ## SDK Status
          - **Package**: @timetracker/api-sdk
          - **NPM**: https://www.npmjs.com/package/@timetracker/api-sdk
          - **Status**: âœ… Published
          
          ---
          Generated by GitHub Actions
          EOF
          cat DEPLOYMENT_REPORT.md

      - name: Upload deployment report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: DEPLOYMENT_REPORT.md
          retention-days: 30

      - name: Create success badge
        run: |
          echo "## âœ… CI/CD Pipeline Success"
          echo ""
          echo "| Component | Status |"
          echo "|-----------|--------|"
          echo "| Build | âœ… |"
          echo "| Tests | âœ… |"
          echo "| Publish | âœ… |"
          echo "| Deploy | âœ… |"
          echo "| SDK | âœ… |"

  failure-notification:
    name: Notify on Failure
    runs-on: ubuntu-latest
    if: failure()
    needs: [build, test, publish, deploy, publish-sdk]

    steps:
      - name: Failure notification
        run: |
          echo "âŒ CI/CD Pipeline Failed"
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Actor: ${{ github.actor }}"
          echo ""
          echo "Check workflow logs for details:"
          echo "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
