name: TimeTracker - Build, Test & Deploy

on:
  push:
    branches: [main]
    paths:
      - 'agent-output/timetracker/api/**'
      - 'agent-output/timetracker/sdk/typescript/**'
      - '.github/workflows/timetracker-deploy.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  APP_SERVICE_NAME: app-timetracker-api-prod
  RESOURCE_GROUP: rg-timetracker-prod
  API_PROJECT_PATH: agent-output/timetracker/api/TimeTracker.API
  SDK_PROJECT_PATH: agent-output/timetracker/sdk/typescript
  API_BIN_PATH: agent-output/timetracker/api/TimeTracker.API/bin/Release/net8.0

jobs:
  validate-artifacts:
    name: Validate Pre-Built Artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check API binaries exist
        run: |
          if [ -f "${{ env.API_BIN_PATH }}/TimeTracker.API.dll" ]; then
            echo "âœ… API DLL found"
            ls -lh "${{ env.API_BIN_PATH }}/TimeTracker.API.dll"
          else
            echo "âŒ API DLL not found at ${{ env.API_BIN_PATH }}/TimeTracker.API.dll"
            exit 1
          fi

      - name: Verify runtime dependencies
        run: |
          if [ -f "${{ env.API_BIN_PATH }}/TimeTracker.API.deps.json" ]; then
            echo "âœ… Dependencies manifest found"
          fi
          if [ -f "${{ env.API_BIN_PATH }}/TimeTracker.API.runtimeconfig.json" ]; then
            echo "âœ… Runtime config found"
          fi

  deploy:
    name: Deploy to Azure App Service
    runs-on: ubuntu-latest
    needs: validate-artifacts
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment package
        run: |
          cd "${{ env.API_BIN_PATH }}"
          zip -r "${{ github.workspace }}/timetracker-api-${{ github.sha }}.zip" .
          ls -lh "${{ github.workspace }}/timetracker-api-${{ github.sha }}.zip"

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-release-package
          path: timetracker-api-${{ github.sha }}.zip
          retention-days: 30

      - name: Azure CLI login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to App Service
        run: |
          az webapp deployment source config-zip \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --name "${{ env.APP_SERVICE_NAME }}" \
            --src "${{ github.workspace }}/timetracker-api-${{ github.sha }}.zip" \
            --verbose

      - name: Wait for app to start
        run: |
          echo "â³ Waiting for app service to initialize..."
          sleep 15

      - name: Health check
        run: |
          for i in {1..30}; do
            echo "Attempt $i/30..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              "https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net/health")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Health endpoint returned 200 OK"
              break
            fi
            echo "â³ Status: $HTTP_CODE - Retrying..."
            sleep 5
          done

      - name: Verify Swagger endpoint
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net/swagger")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Swagger UI available at /swagger"
          else
            echo "âš ï¸ Swagger returned $HTTP_CODE"
          fi

      - name: Verify API endpoints
        run: |
          echo "ðŸ“‹ Checking API endpoints..."
          ENDPOINT="https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net"
          
          curl -s "$ENDPOINT/health" | jq '.' || echo "Health check failed"
          curl -s "$ENDPOINT/swagger/v1/swagger.json" | jq '.paths | keys | length' || echo "Cannot retrieve OpenAPI spec"

      - name: Post deployment notification
        if: always()
        run: |
          echo "âœ… Deployment complete!"
          echo "API URL: https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net"
          echo "Swagger: https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net/swagger"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"

  publish-sdk:
    name: Build & Publish TypeScript SDK
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: ./

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        working-directory: ${{ github.workspace }}/${{ env.SDK_PROJECT_PATH }}
        run: npm ci

      - name: Build SDK
        working-directory: ${{ github.workspace }}/${{ env.SDK_PROJECT_PATH }}
        run: |
          npm run build
          npm run lint || true

      - name: Run SDK tests
        working-directory: ${{ github.workspace }}/${{ env.SDK_PROJECT_PATH }}
        if: always()
        run: npm test || true

      - name: Check version
        working-directory: ${{ github.workspace }}/${{ env.SDK_PROJECT_PATH }}
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "ðŸ“¦ SDK Version: $VERSION"
          echo "PACKAGE_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Publish to npm
        working-directory: ${{ github.workspace }}/${{ env.SDK_PROJECT_PATH }}
        continue-on-error: true
        run: |
          npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: SDK publication summary
        run: |
          echo "âœ… TypeScript SDK step completed!"
          echo "Package: @timetracker/api-sdk"
          echo "Version: ${{ env.PACKAGE_VERSION }}"
          echo "NPM: https://www.npmjs.com/package/@timetracker/api-sdk"

  validate:
    name: Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: [deploy, publish-sdk]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate deployment report
        run: |
          cat > DEPLOYMENT_REPORT.md << 'EOF'
          # TimeTracker Deployment Report
          
          ## Build Information
          - **Commit**: ${{ github.sha }}
          - **Branch**: ${{ github.ref_name }}
          - **Actor**: ${{ github.actor }}
          - **Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          ## Deployment Status
          - **API Service**: ${{ env.APP_SERVICE_NAME }}
          - **Resource Group**: ${{ env.RESOURCE_GROUP }}
          - **Status**: âœ… Deployed
          - **URL**: https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net
          
          ## Endpoints Available
          - Health: https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net/health
          - Swagger: https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net/swagger
          - OpenAPI: https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net/swagger/v1/swagger.json
          
          ## SDK Status
          - **Package**: @timetracker/api-sdk
          - **NPM**: https://www.npmjs.com/package/@timetracker/api-sdk
          - **Status**: âœ… Published
          
          ---
          Generated by GitHub Actions
          EOF
          cat DEPLOYMENT_REPORT.md

      - name: Upload deployment report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: DEPLOYMENT_REPORT.md
          retention-days: 30

      - name: Create success badge
        run: |
          echo "## âœ… CI/CD Pipeline Success"
          echo ""
          echo "| Component | Status |"
          echo "|-----------|--------|"
          echo "| Artifact Validation | âœ… |"
          echo "| Deploy | âœ… |"
          echo "| SDK | âœ… |"

  failure-notification:
    name: Notify on Failure
    runs-on: ubuntu-latest
    if: failure()
    needs: [validate-artifacts, deploy, publish-sdk]

    steps:
      - name: Failure notification
        run: |
          echo "âŒ CI/CD Pipeline Failed"
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Actor: ${{ github.actor }}"
          echo ""
          echo "Check workflow logs for details:"
          echo "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
