#!/bin/sh

# Markdown validation pre-commit hook
echo "üîç Running markdown validation..."

# Get list of staged markdown files
STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.md$')

if [ -n "$STAGED_MD_FILES" ]; then
  echo "üìù Validating $(echo "$STAGED_MD_FILES" | wc -l | tr -d ' ') markdown file(s)..."
  
  # Run markdownlint-cli2 on staged files only
  echo "$STAGED_MD_FILES" | xargs markdownlint-cli2
  
  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå Markdown validation failed!"
    echo "Run 'npm run lint:md:fix' to auto-fix issues, or fix manually."
    exit 1
  fi
  
  echo "‚úÖ All markdown files passed validation"
else
  echo "‚ÑπÔ∏è  No markdown files to validate"
fi

# Wave 1 artifact structure validation
echo ""
echo "üîç Running Wave 1 artifact structure validation..."

# Check if any Wave 1 artifacts are staged
STAGED_WAVE1=$(echo "$STAGED_MD_FILES" | grep -E '(01-requirements|02-architecture-assessment|04-implementation-plan|06-deployment-summary)\.md$' || true)

if [ -n "$STAGED_WAVE1" ]; then
  echo "üìã Validating Wave 1 artifact structure..."
  # RATCHET: Change to STRICTNESS=standard after 2 successful artifact regenerations pass validation
  STRICTNESS=relaxed npm run lint:wave1-artifacts
  
  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå Wave 1 artifact validation failed!"
    echo "Ensure artifact structure matches templates in .github/templates/"
    exit 1
  fi
  
  echo "‚úÖ Wave 1 artifacts passed structure validation"
else
  echo "‚ÑπÔ∏è  No Wave 1 artifacts to validate"
fi
